

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.56.0">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>SharpC2</title>
    <meta name="author" content="Rasta Mouse">
    <meta name="keywords" content="">

    <link rel="icon" href="https://rastamouse.me/favicon.ico">
    

    
    <meta name="description" content="Back in October 2018 (yes, 2018!), I approached begged xpn for a collaboration on an idea I had for a .NET C2 Framework.  We worked on the project for about a month or so before real life got in the way and stalled development.  In February 2019, cobbr released Covenant which is also a .NET C2 Framework.  I subsequently spent some time contributing to, and writing about Covenant - but I&rsquo;ve always wanted to get back to our original project.

I decided to re-visit SharpC2 (a very creative name on my part) over the 2019 Christmas period to try and get it into a position where we could release a proof of concept.  Yet somehow I&rsquo;m not writing this until May 2020!  We can blame my RTO course for that.

This post is intended to provide an overview of SharpC2&rsquo;s design concepts and some showcase examples of how it can be used.  Code can be found on GitHub.">
    <meta property="og:description" content="Back in October 2018 (yes, 2018!), I approached begged xpn for a collaboration on an idea I had for a .NET C2 Framework.  We worked on the project for about a month or so before real life got in the way and stalled development.  In February 2019, cobbr released Covenant which is also a .NET C2 Framework.  I subsequently spent some time contributing to, and writing about Covenant - but I&rsquo;ve always wanted to get back to our original project.

I decided to re-visit SharpC2 (a very creative name on my part) over the 2019 Christmas period to try and get it into a position where we could release a proof of concept.  Yet somehow I&rsquo;m not writing this until May 2020!  We can blame my RTO course for that.

This post is intended to provide an overview of SharpC2&rsquo;s design concepts and some showcase examples of how it can be used.  Code can be found on GitHub.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="SharpC2">
    <meta property="og:url" content="/2020/05/sharpc2/">
    <meta property="og:site_name" content="Rasta Mouse">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Rasta Mouse">
    <meta name="twitter:description" content="Back in October 2018 (yes, 2018!), I approached begged xpn for a collaboration on an idea I had for a .NET C2 Framework.  We worked on the project for about a month or so before real life got in the way and stalled development.  In February 2019, cobbr released Covenant which is also a .NET C2 Framework.  I subsequently spent some time contributing to, and writing about Covenant - but I&rsquo;ve always wanted to get back to our original project.

I decided to re-visit SharpC2 (a very creative name on my part) over the 2019 Christmas period to try and get it into a position where we could release a proof of concept.  Yet somehow I&rsquo;m not writing this until May 2020!  We can blame my RTO course for that.

This post is intended to provide an overview of SharpC2&rsquo;s design concepts and some showcase examples of how it can be used.  Code can be found on GitHub.">
    
      <meta name="twitter:creator" content="@_RastaMouse">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=640">
    

    
      <meta property="og:image" content="https://rastamouse.me/images/sharpc2/thumb.png">
    
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="https://rastamouse.me/css/style-u6mk0ojoywresbx8iepslrmmhl4stuhrsxuwhkpwrkrx7mryjcaimasnk4pi.min.css" />
    
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-60712346-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4"> 
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://rastamouse.me/">Rasta Mouse</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://rastamouse.me/#about">
    
    
    
      
        <img class="header-picture" src="//www.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>
      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://rastamouse.me/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Rasta Mouse</h4>
        
          <h5 class="sidebar-profile-bio">Taylor Swift fan, wannabe Red Teamer &amp; 1337 hax0r (in that order).</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/_RastaMouse" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://keybase.io/rasta_mouse" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-lock"></i>
      
      <span class="sidebar-button-desc">Keybase</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://zeropointsecurity.co.uk/rastalabs/" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-shield"></i>
      
      <span class="sidebar-button-desc">RastaLabs</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/rasta-mouse" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://rastamouse.me/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      SharpC2
    </h1>
  
  <div class="postShorten-meta post-meta">
  
    <time itemprop="datePublished" datetime="2020-05-10T00:00:00Z">
      
  
  
  
  
    10 May 2020
  

    </time>
  
  
  
  
    <span>in</span>
    
      <a class="category-link" href="https://rastamouse.me/categories/blog">blog</a>
    
  


</div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Back in October 2018 (yes, 2018!), I <del>approached</del> begged <a href="https://twitter.com/_xpn_">xpn</a> for a collaboration on an idea I had for a .NET C2 Framework.  We worked on the project for about a month or so before real life got in the way and stalled development.  In February 2019, <a href="https://twitter.com/cobbr_io">cobbr</a> released <a href="https://github.com/cobbr/Covenant">Covenant</a> which is also a .NET C2 Framework.  I subsequently spent some time <a href="https://github.com/cobbr/Covenant/commits?author=rasta-mouse">contributing</a> to, and <a href="https://rastamouse.me/tags/covenant/">writing about</a> Covenant - but I&rsquo;ve always wanted to get back to our original project.</p>

<p>I decided to re-visit SharpC2 (a very creative name on my part) over the 2019 Christmas period to try and get it into a position where we could release a proof of concept.  Yet somehow I&rsquo;m not writing this until May 2020!  We can blame my <a href="https://www.zeropointsecurity.co.uk/annoucements/2020/4/13/red-team-ops-is-back">RTO course</a> for that.</p>

<p>This post is intended to provide an overview of SharpC2&rsquo;s design concepts and some showcase examples of how it can be used.  Code can be found on <a href="https://github.com/SharpC2/SharpC2/tree/dev">GitHub</a>.</p>

<h3 id="project-outcomes">Project Outcomes</h3>

<p>Before diving into any code, like any good software dev team ðŸ¤ª we had a discussion regarding what the tooling should, could and won&rsquo;t do.  The MoSCoW method is a good typical business example, which is short for &ldquo;must have&rdquo;, &ldquo;should have&rdquo;, &ldquo;could have&rdquo; and &ldquo;won&rsquo;t have&rdquo;.</p>

<p>We decided very early on that the main priorities for the framework were:</p>

<ol>
<li><p>Transparency - the framework, the Agent in particular, <strong>must not</strong> abstract anything (important) away from the visibility or control of the operator.</p></li>

<li><p>Modularity - the operator <strong>must have</strong> free reign to add, subtract or override the default behaviour and capabilities of both the Agents and Team Server.  I tried to coin this term &ldquo;Bring your own Pwnage&rdquo; (or maybe I heard this somewhere else&hellip;).</p></li>

<li><p>Base Primitives - as the lead devs, we <strong>won&rsquo;t</strong> provide a plethora of post-ex functionality (persistence, priv esc, lateral movement etc).  We <strong>should</strong> instead focus on providing a stable set of core / base primitives, which an operator can leverage to carry out their own tradecraft.</p></li>
</ol>

<h3 id="solution">Solution</h3>

<p>Right now, the SharpC2 Visual Studio Solution is made of 7 projects.</p>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/vs-solution.png"/> 
</figure>


<ul>
<li>HTTPAgent / TCPAgent - .NET Framework Console Applications</li>
<li>Team Server - an ASP.NET Core 3.1 Web Application</li>
<li>Agent Modules - .NET Standard Class Libraries</li>
<li>Agent / C2 Shared Projects</li>
</ul>

<h4 id="the-agents">The Agents</h4>

<p>SharpC2 has an HTTP Agent for egress and a TCP Agent for peer-to-peer.</p>

<p>The core components are found in the shared Agent project - this allows rapid code-reuse between the different agent flavors (HTTP, TCP, etc) without copy/paste-style duplication.  A shared project is more useful for our use-case compared to a class library, since class libraries compile to a DLL that would be required alongside an agent executable to run.  With shared projects, the agent will compile to a standalone exe.</p>

<p>The Agents (as well as the Team Server) has 3 main internal components:</p>

<ul>
<li>Controllers</li>
<li>Interfaces</li>
<li>Modules</li>
</ul>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/vs-agent.png"/> 
</figure>


<p>In most cases, an operator should not need to modify the Controllers or Interfaces unless they want to make significant changes to the internals.  The <code>AgentController</code> provides public methods such as <code>SendCommandOutput</code> that are used by other Modules (more on those in a bit), which simply queues up command and control data to be sent by the <code>CommModule</code>.  The <code>ConfigurationController</code> allows an operator to set options within the Agent, such as its sleep and jitter.</p>

<p>The three interfaces provided are <code>IAgentModule</code>, <code>ICommModule</code> and <code>ICommRelay</code>.  An AgentModule is responsible for providing command functionality for the Agent. A CommModule is responsible for sending and receiving C2 data to/from the Team Server. A CommRelay simply takes the input from one CommModule and puts it into the output of another CommModule.</p>

<p>An AgentModule only requires two methods - <code>GetModuleInfo</code> which returns a class of <code>AgentModuleInfo</code> and <code>Initialise</code>.  <code>AgentModuleInfo</code> contains all the information required for an agent module including a Name and a List of AgentCommand.  An AgentCommand also contains a Name, Description, HelpText and a Callback.  When an Agent Module is initialised, this information is sent back to the Team Server so it may become available to the operators.  This is in contrast to Covenant where all Grunt Task definitions are stored ahead of time on the server.  An advantage of our approach is that no server-side changes are required to provide new Agent functionality, at the cost of some additional C2 traffic.  <code>Initialise</code> registers the AgentModule with the Agent itself and any other steps may be required for the module (such as setting some default configuration options).</p>

<p>Here&rsquo;s an example from the CoreAgentModule:</p>

<pre><code class="language-c#">public AgentModuleInfo GetModuleInfo()
{
    return new AgentModuleInfo
    {
        Name = &quot;Core&quot;,
        Developer = &quot;Daniel Duggan, Adam Chester&quot;,
        Commands = new List&lt;AgentModuleInfo.AgentCommand&gt;
        {
            new AgentModuleInfo.AgentCommand
            {
                Name = &quot;ls&quot;,
                Description = &quot;List a Directory&quot;,
                HelpText = &quot;ls [path]&quot;,
                Callback = ListDirectory
            },
            new AgentModuleInfo.AgentCommand(...),
            new AgentModuleInfo.AgentCommand(...),
            new AgentModuleInfo.AgentCommand(...),
            new AgentModuleInfo.AgentCommand(...),
            new AgentModuleInfo.AgentCommand(...),
            new AgentModuleInfo.AgentCommand(...)
        }
    };
}

public void Initialise(AgentController agent, ConfigController config)
{
    var moduleInfo = GetModuleInfo();
    agent.RegisterAgentModule(moduleInfo);
    agent.SendModuleRegistered(moduleInfo);
}

private void ListDirectory(string data, AgentController agent, ConfigurationController config)
{
    string results = // do some stuff
    agent.SendCommandOutput(results);
}
</code></pre>

<p>The Callback comes from a delegate within the AgentController.</p>

<pre><code class="language-c#">public delegate void OnAgentCommand(string data, AgentController agentController, ConfigurationController configController);
</code></pre>

<p>A CommModule requires <code>Initialise</code>, <code>Run</code>, <code>SendData</code>, <code>RecvData</code> and <code>Stop</code>.  Within our example HTTPCommModule, <code>Initialise</code> simply brings in an instance of the ConfigurationController so that it can retrieve those sleep / jitter values. <code>Run</code> puts the module into a loop for as long as the Agent is running.  It checks into the Team Server over HTTP GET, retrieves any jobs and places them into an inbound queue. <code>RecvData</code> dequeue&rsquo;s the inbound queue - the jobs are processed by the AgentController and (providing the job matches a &ldquo;known&rdquo; command within the AgentModuleInfo) the appropriate callback is executed.  When an Agent Module calls <code>SendCommandOutput</code>, the C2 data is placed in an outbound queue. The <code>SendData</code> method will enqueue and send the results back to the Team Server on next check-in.</p>

<p>Obviously an operator can implement any communication method within an ICommModule - it&rsquo;s not limited to HTTP.  This opens the door for other exoteric C2 channels without requiring an external solution like <a href="https://github.com/FSecureLABS/C3">C3</a>, as well as peer-to-peer comms such as TCP or SMB.</p>

<p>The <code>ICommRelay</code> requires two methods: <code>GarbageIn</code> and <code>GarbageOut</code>.  A relay does not do any reading or processing on the data.  The HTTP Agent has its HTTPCommModule to talk to the Team Server and a TCPModule to connect to TCP Agents.  The CommRelay will take incoming data from the TCPModule and passes it to the outbound queue of HTTPCommModule.  No more, no less.</p>

<h4 id="team-server">Team Server</h4>

<p>The architecture of the Team Sever is very similar, in that the core components are also Controllers, Interfaces and Modules.</p>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/vs-teamserver.png"/> 
</figure>


<p>The <code>ClientController</code> handles client authentication and returns information requested about authenticated users.  The <code>AgentController</code> handles the session data from agents currently checking into the Team Server and the <code>ServerController</code> acts as a bridge between the different components that need to talk to each other.</p>

<p>The <code>ICommModule</code> and <code>HTTPCommModule</code> behaves as expected, by binding a port and receiving/sending data to Agents.  The same in/out queue system is used here.  The <code>CoreServerModule</code> is responsible for handling output from agents, such as when new agents check-in or when command output is received.</p>

<p>The <code>PortFwdModule</code> is an example of how new server-side functionality can be added, which works in conjunction with the external <code>PortFwd</code> Agent Module.</p>

<h4 id="external-agent-modules">External Agent Modules</h4>

<p>An Agent Module may be compiled into the agent (like the CoreAgentModule), or they can be external and loaded at runtime.</p>

<p>Like <a href="https://github.com/cobbr/SharpSploit">SharpSploit</a>, external agent modules are .NET Standard DLLs.  To maximize compatibility, SharpSploit is .NET Framework 3.5 and 4.0 compliant so it can run on CLR versions 2.0 and 4.  However, if you&rsquo;ve developed anything in .NET you&rsquo;ll appreciate how much of a pain backwards-compatibility can be.  I mean, no LINQ, really&hellip;?  For this reason and the EoL of platforms such as Windows 7, I&rsquo;m not personally interested in maintaining this level compatibility.  So even though agent modules are .NET Standard, they are only built for CLR 4 and we&rsquo;ll see what happens with .NET 5.</p>

<p>The default CoreAgentModule only provides very basic functionality such as <code>ls</code>, <code>pwd</code>, <code>cd</code>, <code>sleep</code>, <code>loadmodule</code>, <code>link</code> and <code>exit</code>.  It doesn&rsquo;t even include any type of shell command.  This functionality can be added via external agent modules and the <code>loadmodule</code> command.  This will take the provided assembly and call:</p>

<pre><code class="language-c#">var assembly = Assembly.Load(Helpers.Base64Decode(data));
var module = assembly.CreateInstance(&quot;Agent.AgentModule&quot;, true);
var agentModule = module as IAgentModule;
agentModule.Initialise(agent, config);
</code></pre>

<p>Therefore, an agent module must implement the IAgentModule interface, share the same <code>Agent</code> namespace and a class of <code>AgentModule</code>.</p>

<p>This approach allows an operator to implement <em>any</em> post-ex capability in <em>any</em> way they see fit and keeps the core agent executable relatively small and benign.  The obvious downsides are the development overhead and having to push DLLs down the C2 channel.</p>

<p>Covenant is similar in that post-ex tasks are compiled dynamically server-side, retrieved by the Grunt and invoked:</p>

<pre><code class="language-c#">Assembly gruntTask = Assembly.Load(decompressedBytes);
var results = gruntTask.GetType(&quot;Task&quot;).GetMethod(&quot;Execute&quot;).Invoke(null, parameters);
</code></pre>

<p>An advantage of <code>CreateInstance</code> over <code>Load</code> is that it allows easier access to the defined methods and variables after the event.  In the current Covenant world, consider if we had an assembly like:</p>

<pre><code class="language-c#">public class Example
{
    public static void Start()
    {
        // start something
    }

    public static void Stop()
    {
        // stop something
    }
}
</code></pre>

<p>We could do <code>Assembly.Load(); GetType(&quot;Example&quot;).GetMethod(&quot;Start&quot;).Invoke(null, parameters);</code> but we wouldn&rsquo;t have subsequent access to the <code>Stop()</code> method.  We can&rsquo;t do <code>Assembly.Load(); GetType(&quot;Example&quot;).GetMethod(&quot;Stop&quot;).Invoke(null, parameters);</code> because we&rsquo;d have loaded a completely new instance of the assembly.</p>

<p>That&rsquo;s not a problem with <code>CreateInstance</code> - the disadvantage being that the assembly hangs around whilst the agent is running.</p>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/stageone-loaded.png"/> 
</figure>


<h3 id="demo">Demo</h3>

<p>The TeamServer has a very basic Blazor interface to demo the functionality of the framework. The 3 elements to this view are the agent grid (top), command output (middle), command box (bottom).</p>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/agent-basic.png"/> 
</figure>


<p>To interact with an agent, simply click on it in the grid.  The command output region will show any output from that agent and the placeholder in the command box will update to reflect the selected agent&rsquo;s ID.</p>

<p>Commands are issued in the format <code>[module] [command] [data]</code>.  For example <code>core pwd</code> or <code>core ls C:\</code>.  Typing <code>help</code> will show the commands available.  This is contextual to each agent, depending on the modules that are loaded.</p>

<p>To load an external module, we must encode to a base64 string.</p>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/agent-loadmodule.png"/> 
</figure>


<p>Chain multiple TCP Agents using the <code>link</code> command.</p>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/agent-tcpchain.png"/> 
</figure>


<p>The StageOne module extends the agent by providing fork-and-run-style capabilities.  That is, to spawn a sacrificial process to house post-ex functionality.</p>

<p>By default, processes with PPID themselves to the agent.</p>

<pre><code class="language-text">[+] 10/05/2020 15:50:11 : AgentCommandRequest

stageone run ping 127.0.0.1 -n 30

[+] 10/05/2020 15:50:40 : AgentCommandResponse

Pinging 127.0.0.1 with 32 bytes of data:
Reply from 127.0.0.1: bytes=32 time&lt;1ms TTL=128
Reply from 127.0.0.1: bytes=32 time&lt;1ms TTL=128
Reply from 127.0.0.1: bytes=32 time&lt;1ms TTL=128
Reply from 127.0.0.1: bytes=32 time&lt;1ms TTL=128
</code></pre>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/ping-default.png"/> 
</figure>


<pre><code class="language-text">[+] 10/05/2020 15:53:46 : AgentCommandRequest

stageone ppid 10992

[+] 10/05/2020 15:53:46 : AgentCommandResponse

Process Id  Process Name
----------  ------------
10992       Explorer.EXE
</code></pre>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/ping-ppid.png"/> 
</figure>


<p>I have a demo .NET assembly that can be turned into shellcode (with <a href="https://github.com/TheWover/donut">donut</a>), injected into a sacrificial process and the output collected.</p>

<pre><code class="language-c#">using System;
using System.Threading;

class Program
{
    public static void Main(string[] args)
    {
        Thread.Sleep(30000); // time to take a screenshot :)
        Console.WriteLine(&quot;Hello from .NET assembly&quot;);
    }
}
</code></pre>

<pre><code class="language-text">[+] 10/05/2020 16:03:37 : AgentCommandRequest

stageone disableetw  true

[+] 10/05/2020 16:03:37 : AgentCommandResponse

Disabled
--------
True
</code></pre>

<figure>
    <img src="https://rastamouse.me/images/sharpc2/notepad-clr.png"/> 
</figure>


<pre><code class="language-text">[+] 10/05/2020 17:32:56 : AgentCommandResponse

Hello from .NET assembly
</code></pre>

<h4 id="conclusion">Conclusion</h4>

<p>This was a quick demo of SharpC2 -  I hope you can see its potential.  I find the idea an open source framework that can provide capabilities such as PPID spoofing, process mitigation policies and ETW patching very exciting.</p>

<p>There&rsquo;s a lot more development work to do before this can be used for anything useful in the real world - the focus will be on adding stable post-ex primitives.  My primary use case for this as a learning and training tool, not for carrying out actual engagements and the priority for development will reflect that.</p>

<p>I&rsquo;m also not convinced Blazor is a good long-term UI solution for this type of tool.  There&rsquo;s a heavy emphasis on leveraging files from your local machine and an ideal UI would allow command line tab completion to grab assemblies directly from disk.  E.g. <code>stageone spawn C:\Path\To\Assembly.exe</code>.  Although cross-platform GUI solutions are thin on the ground <em>cough-Electron-cough</em>&hellip;</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://rastamouse.me/tags/red-team/">red team</a>

  <a class="tag tag--primary tag--small" href="https://rastamouse.me/tags/c2/">c2</a>

  <a class="tag tag--primary tag--small" href="https://rastamouse.me/tags/c/">c#</a>

  <a class="tag tag--primary tag--small" href="https://rastamouse.me/tags/framework/">framework</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--disabled">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://rastamouse.me/2020/02/gadgettojscript/" data-tooltip="GadgetToJScript">
          
            <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 Rasta Mouse. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--disabled">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://rastamouse.me/2020/02/gadgettojscript/" data-tooltip="GadgetToJScript">
          
            <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
        <i class="fa fa-google-plus"></i><span>Share on Google Plus</span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
        <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3a%2f%2frastamouse.me%2f2020%2f05%2fsharpc2%2f">
        <i class="fa fa-twitter"></i><span>Share on Twitter</span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Rasta Mouse</h4>
    
      <div id="about-card-bio">Taylor Swift fan, wannabe Red Teamer &amp; 1337 hax0r (in that order).</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Penetration Tester
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        UK
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="Search" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center">no post found</div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/post/">
                <h3 class="media-heading">Posts</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  May 5, 2020
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2020/05/sharpc2/">
                <h3 class="media-heading">SharpC2</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  May 5, 2020
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Back in October 2018 (yes, 2018!), I <del>approached</del> begged <a href="https://twitter.com/_xpn_">xpn</a> for a collaboration on an idea I had for a .NET C2 Framework.  We worked on the project for about a month or so before real life got in the way and stalled development.  In February 2019, <a href="https://twitter.com/cobbr_io">cobbr</a> released <a href="https://github.com/cobbr/Covenant">Covenant</a> which is also a .NET C2 Framework.  I subsequently spent some time <a href="https://github.com/cobbr/Covenant/commits?author=rasta-mouse">contributing</a> to, and <a href="https://rastamouse.me/tags/covenant/">writing about</a> Covenant - but I&rsquo;ve always wanted to get back to our original project.</p>

<p>I decided to re-visit SharpC2 (a very creative name on my part) over the 2019 Christmas period to try and get it into a position where we could release a proof of concept.  Yet somehow I&rsquo;m not writing this until May 2020!  We can blame my <a href="https://www.zeropointsecurity.co.uk/annoucements/2020/4/13/red-team-ops-is-back">RTO course</a> for that.</p>

<p>This post is intended to provide an overview of SharpC2&rsquo;s design concepts and some showcase examples of how it can be used.  Code can be found on <a href="https://github.com/SharpC2/SharpC2/tree/dev">GitHub</a>.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2020/02/gadgettojscript/">
                <h3 class="media-heading">GadgetToJScript</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Feb 2, 2020
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Back in April 2017, <a href="https://twitter.com/tiraniddo">James Forshaw</a> (hail) released a tool called <a href="https://github.com/tyranid/DotNetToJScript">DotNetToJScript</a> which was capable of generating JScript, VBA and VBScript that could run an arbitrary .NET assembly (mostly) from memory.  Although not its intended purpose, it was quickly picked up by tool developers, pentesters, red teamers, bad guys etc and used to deliver .NET-based payloads via methods such as <a href="https://en.wikipedia.org/wiki/HTML_Application">HTA</a>.</p>

<p>Microsoft and other AV vendors started writing signatures for DN2JS, and we all know how that makes James feel (Exhibits <a href="https://twitter.com/tiraniddo/status/1204970332127236097">A</a> and <a href="https://twitter.com/tiraniddo/status/951489836027990019">B</a>).  Microsoft even went as far as to make some under-the-hood changes from Windows 10 / 2K16 to mitigate the use of DN2JS payloads, as evidenced by these notes in Covenant:</p>

<figure>
    <img src="https://rastamouse.me/images/gadgettojscript/covenant.png"/> 
</figure>


<p>These factors seem to have resulted in a decline in prevalence for these payloads, or at least, they&rsquo;re not hyped about so much.</p>

<p>Enter <a href="https://github.com/med0x2e/GadgetToJScript">GadgetToJScript</a> by <a href="https://twitter.com/med0x2e">Mohamed El Azaar</a>.  This tool generates .NET serialized gadgets that can trigger assembly load/execution when deserialized via BinaryFormatter from JScript, VBScript or VBA.  So it once again, allows for a similar tradecraft as was originally provided by DN2JS <strong>and</strong> it works on Windows 10.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/12/covenant-tasks-101/">
                <h3 class="media-heading">Covenant Tasks 101</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Covenant is a .NET Command and Control framework that boasts a number of exciting features for red teamers.  The Covenant implants are called Grunts, which are capable of executing post-exploitation <strong>&ldquo;tasks&rdquo;</strong> on a compromised machine.  Covenant v0.1 released with a number of useful tasks, but the repository has really <a href="https://github.com/cobbr/Covenant/graphs/commit-activity">grown</a> from contributions from the Covenant community.</p>

<p>Tasks can extend the functionality and versatility of a Grunt, such as providing new lateral movement, persistence or privilege escalation techniques and more.  Contributing a Task to Covenant is an excellent way to support the project.</p>

<p>This post will provide an introduction for those wishing to create and contribute new Tasks.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/09/mwr-labs-c3-first-look/">
                <h3 class="media-heading">MWR Labs: C3 - First Look</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Sep 9, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In this blog post I&rsquo;m going to cover my first impressions of MWR Labs C3 project, through installation and setup to usage in a basic scenario.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/08/tikiservice/">
                <h3 class="media-heading">TikiService</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><a href="https://github.com/rasta-mouse/TikiTorch/tree/master/TikiService">TikiService</a> is a new .NET Service Binary that allows you to run a TikiTorch payload via the Service Control Manager (Ã  la PsExec).  <a href="https://github.com/rasta-mouse/TikiTorch/blob/master/Aggressor/TikiTorch.cna">TikiTorch.cna</a> has also been updated to create a new Cobalt Strike function: <code>tikiexec</code>, that automates its use.  This blog post provides a brief overview and usage examples.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/08/covenant-donut-tikitorch/">
                <h3 class="media-heading">Covenant, Donut, TikiTorch</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Covenant <a href="https://github.com/cobbr/Covenant/commit/bde0df315f26b01a4ef5c5c00679b1e150998a35">v0.1</a> was first released in February 2019 and has since received a lot of really good updates.  <a href="https://github.com/cobbr/Covenant/commit/a2df643e01aea3ad7330bdba88ddd560692e46b4">v0.2</a> was released in May which added p2p comms over SMB named pipes, and <a href="https://github.com/cobbr/Covenant/commit/abcba78006c29b687f6e1a43a1ea1793784714fd">v0.3</a> was released in August which added a brand new web interface.  Even though it&rsquo;s such a young project, it has really proven itself to be a capable tool for offensive operators.  I&rsquo;ve not taken a look at Covenant since v0.1.x but since providing some new <a href="https://github.com/cobbr/SharpSploit/blob/master/SharpSploit/Persistence/WMI.cs">additions</a> to SharpSploit, it kinda got my geek going.  One of my areas of interest is weaponising the Grunt stager.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/06/the-return-of-aggressor/">
                <h3 class="media-heading">The Return of Aggressor</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>FortyNorth Security recently <a href="https://www.fortynorthsecurity.com/aggressive-msbuild-bypass-detection/">posted an article</a> detailing the process for leveraging MSBuild to execute unmanaged PowerShell, and automating it in Aggressor script for Cobalt Strike users.  Being a native binary in the Windows OS, the use of MSBuild is a <a href="https://lolbas-project.github.io/lolbas/Binaries/Msbuild/">common AWL bypass technique</a>, which is handy in relatively well locked down environments.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/06/tikivader/">
                <h3 class="media-heading">TikiVader</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>I&rsquo;ve added a new experimental project to <a href="https://github.com/rasta-mouse/TikiTorch">TikiTorch</a>, called <a href="https://github.com/rasta-mouse/TikiTorch/tree/master/TikiVader">TikiVader</a>.  I originally thought of &ldquo;vader&rdquo; as a play-on for &ldquo;evade&rdquo;/&ldquo;evader&rdquo;, until I realised TikiVader was never meant to evade anything&hellip; but nevermind ðŸ˜’</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://rastamouse.me/2019/06/tikispawn-msbuild/">
                <h3 class="media-heading">TikiSpawn &amp; MSBuild</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The main impetus behind this post was me experimenting with ways to leverage TikiSpawn with some of the popular <a href="https://lolbas-project.github.io">lolbins</a>.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero="no post found"
         data-message-one="1 post found"
         data-message-other="{n} posts found">
         36 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://rastamouse.me/images/cover.jpg');"></div>
  


    
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.js"></script>


<script src="https://rastamouse.me/js/script-wl33z0n6ocaypepiqrazthtivfrliqijej4rq8ek8gvrv1awftmgjuv8k4zc.min.js"></script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight').each(function(i, block) {
    var code = "";
    hljs.highlightAuto(block.innerText).value.split(/\r\n|\r|\n/).forEach(function(line) {
      code += "<span class=\"line\">" + line + "</span><br>";
    });
    if (code.length > 0) {
      block.innerHTML = code;  
    }
  });
  $('pre > code').each(function(i, block) {
    $(this).addClass('codeblock');
    hljs.highlightBlock(block);
  });
});
</script>

  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/rastamouse.me\/2020\/05\/sharpc2\/';
          
            this.page.identifier = '\/2020\/05\/sharpc2\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'rastamouse';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  





    
  </body>
</html>

